<h1 id="2022-06-02"><a aria-hidden="true" class="anchor-heading" href="#2022-06-02"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>2022-06-02</h1>
<p>stackbit/packages/dev-common/src/runner/editor.js</p>
<h2 id="1-todo-move-out-of-common-package"><a aria-hidden="true" class="anchor-heading" href="#1-todo-move-out-of-common-package"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>1. TODO move out of common package</h2>
<p>L370</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">async</span> <span class="token function">getObjectsWithAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">{</span> annotationTree <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span> clientAnnotationErrors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> locale<span class="token punctuation">,</span> reportAllErrors <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fieldData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cms</span><span class="token punctuation">.</span><span class="token method function property-access">getLocalizedFieldData</span><span class="token punctuation">(</span>locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> objects<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> errors <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveObjectsWithAnnotationTree</span><span class="token punctuation">(</span>annotationTree<span class="token punctuation">,</span> fieldData<span class="token punctuation">,</span> <span class="token punctuation">{</span> resolveAllReferences<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">populateReferenceLabels</span><span class="token punctuation">(</span>objects<span class="token punctuation">,</span> fieldData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO move out of common package</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reportAllErrors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> allErrors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>errors<span class="token punctuation">,</span> <span class="token spread operator">...</span>clientAnnotationErrors<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> displayErrors <span class="token operator">=</span> allErrors<span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span>displayErrors<span class="token punctuation">,</span> error <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> errorProps <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token method function property-access">omit</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">userLogger</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span><span class="token property-access">message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span>errorProps<span class="token punctuation">,</span> <span class="token punctuation">(</span>val<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val <span class="token operator">&#x26;&#x26;</span> val<span class="token punctuation">.</span><span class="token property-access">toString</span> <span class="token operator">?</span> val<span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> diffErrors <span class="token operator">=</span> allErrors<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> displayErrors<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>diffErrors <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">userLogger</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>displayErrors<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> Annotation errors shown (out of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>allErrors<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">). Use \`stackbit dev\` locally to view all.</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> objects<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> errors <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-ssg-server-post-_objectswithannotations"><a aria-hidden="true" class="anchor-heading" href="#2-ssg-server-post-_objectswithannotations"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>2. ssg-server (POST /_objectsWithAnnotations)</h2>
<pre class="language-ts"><code class="language-ts">server<span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token string">'/_objectsWithAnnotations'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>bodyParser<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token string">'500kb'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token method function property-access">debug</span><span class="token punctuation">(</span><span class="token string">'[ssg-server] get objects with annotations'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> annotationTree<span class="token punctuation">,</span> clientAnnotationErrors<span class="token punctuation">,</span> locale <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span> runner<span class="token punctuation">.</span><span class="token method function property-access">getObjectsWithAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">{</span> annotationTree<span class="token punctuation">,</span> clientAnnotationErrors<span class="token punctuation">,</span> locale <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span>result <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token method function property-access">debug</span><span class="token punctuation">(</span><span class="token string">'[ssg-server] done getting objects with annotations'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          res<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>err <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token string">'[ssg-server] error getting fieldData with annotations from runner'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>error<span class="token operator">:</span> err<span class="token punctuation">.</span><span class="token property-access">message</span> <span class="token operator">||</span> err<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'stack'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              logger<span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token string">'[ssg-server] error getting fieldData with annotations from runner, error.stack: '</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token property-access">stack</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          res<span class="token punctuation">.</span><span class="token method function property-access">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'Error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>